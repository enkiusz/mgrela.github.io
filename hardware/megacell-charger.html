<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-01-13 21:43 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Megacell Charger</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Maciej Grela" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Megacell Charger</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org57bbcd2">1. Introduction</a></li>
<li><a href="#org705615d">2. Hardware</a></li>
<li><a href="#org4a63459">3. Software</a></li>
<li><a href="#org77f3f27">4. The protocol</a>
<ul>
<li><a href="#orgb283a6f">4.1. Charger presence detection and API version</a></li>
<li><a href="#orge3cae45">4.2. API v0</a>
<ul>
<li><a href="#org4d1fba1">4.2.1. Get charger configuration</a></li>
<li><a href="#org6245974">4.2.2. Set charger configuration</a></li>
<li><a href="#org4ba84ae">4.2.3. Charger reset</a></li>
<li><a href="#org82daf1e">4.2.4. Get current cell information</a></li>
<li><a href="#orgf533da6">4.2.5. Performing actions by the charger</a></li>
<li><a href="#org55c6c05">4.2.6. Changing the log level</a></li>
</ul>
</li>
<li><a href="#orgb4db2f6">4.3. The debug log</a></li>
</ul>
</li>
</ul>
</div>
</div>
<base href="megacell-charger/"/>

<div id="outline-container-org57bbcd2" class="outline-2">
<h2 id="org57bbcd2"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
This page gathers independent information about the Megacell Charger focusing primarily on the communications protocol used between the Megacell Monitor and the Megacell Charger
with the purpose of creating custom automation.
</p>

<p>
All of this information has been independently discovered, later to be found documented on <a href="http://manual.megacellmonitor.com:3000/en/APIspecifications">MegaCell Monitor Wiki</a>. The "wiki" here is unfortunately not editable and may disappear at
any time so the information here is likely to stay relevant as a backup.
</p>
</div>
</div>

<div id="outline-container-org705615d" class="outline-2">
<h2 id="org705615d"><span class="section-number-2">2</span> Hardware</h2>
<div class="outline-text-2" id="text-2">
<p>
The <a href="https://megacellcharger.com">Megacell charger</a> is a 16-slot 18650 litihium ion cell charger with some automation capabilities and software control via 802.11 WLAN. The charger is bundled with software
which implements features useful for larger-scale lithium-ion cell refurbishment and reuse. The charger is built around an ESP8266 module which seems to be running NodeMCU.
</p>
</div>
</div>

<div id="outline-container-org4a63459" class="outline-2">
<h2 id="org4a63459"><span class="section-number-2">3</span> Software</h2>
<div class="outline-text-2" id="text-3">
<p>
The charger is bundled with a software package called <a href="https://www.megacellmonitor.com/">Megacell Monitor</a> which allows for a degree of remote control, setup and automation of the charger. It can also store
the cell information in an SQL database, print labels or calculate pack layouts based on the cells inside it's database.
</p>
</div>
</div>

<div id="outline-container-org77f3f27" class="outline-2">
<h2 id="org77f3f27"><span class="section-number-2">4</span> The protocol</h2>
<div class="outline-text-2" id="text-4">
<p>
The protocol is based on HTTP, the charger has to be connected to a 802.11 WLAN network and obtains it's IP address using DHCP. The following requests are understood by
the charger (assuming 10.10.10.30 is the charger IP address):
</p>
</div>

<div id="outline-container-orgb283a6f" class="outline-3">
<h3 id="orgb283a6f"><span class="section-number-3">4.1</span> Charger presence detection and API version</h3>
<div class="outline-text-3" id="text-4-1">
<pre>
$ curl -i -X POST http://10.10.10.30/api/who_am_i
HTTP/1.1 200 OK
Content-Type: text/json
Content-Length: 35
Connection: close

{
  "McC": "Firmware V4.3.0.11"
}
</pre>

<p>
This request is used to scan an IP subnet to detect the presence of chargers which are online. It also allows to obtain the firmware version which might be used to activate
firmware-specific features and improve compatibility.
</p>
</div>
</div>

<div id="outline-container-orge3cae45" class="outline-3">
<h3 id="orge3cae45"><span class="section-number-3">4.2</span> API v0</h3>
<div class="outline-text-3" id="text-4-2">
<p>
As the charger API has no explicit version code, the current API observed to be implemented in firmware version V4.3.0.11 has been designated as v0.
</p>
</div>

<div id="outline-container-org4d1fba1" class="outline-4">
<h4 id="org4d1fba1"><span class="section-number-4">4.2.1</span> Get charger configuration</h4>
<div class="outline-text-4" id="text-4-2-1">
<pre>
$ curl -X POST http://10.10.10.30/api/get_config_info
{
  "MaV": 4.2,
  "StV": 3.7,
  "MiV": 3,
  "DiR": 1000,
  "MaT": 40,
  "DiC": 1,
  "FwV": "Firmware V4.3.0.11",
  "FirmwareVersion": "Firmware V4.3.0.11",
  "ChC": false,
  "LmV": 0.3,
  "LcV": 3.6,
  "LmD": 1.1,
  "LmR": 90,
  "McH": 240,
  "LcR": 1000,
  "CcO": 1,
  "DcO": 1,
  "MsR": 250,
  "MuL": 0
}
</pre>

<p>
The parameters here are set in the "Settings" menu of Megacell Monitor UI in two different windows - "Charger Settings" and "Circuit Breaker". They meaning of particular
codes is as follows. For some parameters the minimum and maximum values permitted by the UI have been documented. It is not known whether these limits reflect limitations of
the hardware or firmware in the Megacell Charger or whether they are what the developers considered "sensible".
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-right" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Parameter code</th>
<th scope="col" class="org-left">Name in Megacell Monitor UI (in Settings)</th>
<th scope="col" class="org-right">Default value in Megacell Monitor UI</th>
<th scope="col" class="org-left">Value restriction in Megacell Monitor UI</th>
<th scope="col" class="org-left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">MaV</td>
<td class="org-left">Charger Settings -&gt; Max Voltage (V)</td>
<td class="org-right">4.2</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">StV</td>
<td class="org-left">Charger Settings -&gt; Store Voltage (V)</td>
<td class="org-right">3.7</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MiV</td>
<td class="org-left">Charger Settings -&gt; Min Voltage (V)</td>
<td class="org-right">3</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">DiR</td>
<td class="org-left">Charger Settings -&gt; Max Discharge (mAh) (sic!)</td>
<td class="org-right">1000</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MaT</td>
<td class="org-left">Charger Settings -&gt; Max Temp (C)</td>
<td class="org-right">40</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">DiC</td>
<td class="org-left">Charger Settings -&gt; Discharge Cycles</td>
<td class="org-right">1</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">FwV</td>
<td class="org-left">Charger Settings -&gt; Firmware version</td>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Cannot be changed in UI</td>
</tr>

<tr>
<td class="org-left">MuL</td>
<td class="org-left">Charger Settings -&gt; Multicast enable</td>
<td class="org-right">0</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">ChC</td>
<td class="org-left">Not presented in UI directly</td>
<td class="org-right">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Chip-controlled charging enable</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">LmV</td>
<td class="org-left">Circuit Breaker -&gt; LVC Minimum voltage (V)</td>
<td class="org-right">0.3</td>
<td class="org-left">min 0.01, max 3.0</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LcV</td>
<td class="org-left">Circuit Breaker -&gt; LVC charge voltage (V)</td>
<td class="org-right">3</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LmD</td>
<td class="org-left">Circuit Breaker -&gt; LVC Max voltage drop (V)</td>
<td class="org-right">1.1</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LmR</td>
<td class="org-left">Circuit Breaker -&gt; LVC Max trickle time (minutes)</td>
<td class="org-right">90</td>
<td class="org-left">min 5, max 180</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">McH</td>
<td class="org-left">Circuit Breaker -&gt; Max Charge time (minutes)</td>
<td class="org-right">240</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">LcR</td>
<td class="org-left">Circuit Breaker -&gt; Reject cells with low capacity (mA) (sic!)</td>
<td class="org-right">1000</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">CcO</td>
<td class="org-left">Charger Settings -&gt; Charge Correction Factor (%)</td>
<td class="org-right">1</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">DcO</td>
<td class="org-left">Charger Settings -&gt; Discharge Correction Factor (%)</td>
<td class="org-right">1</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">MsR</td>
<td class="org-left">Circuit Breaker -&gt; Max ESR value (mΩ)</td>
<td class="org-right">250</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org6245974" class="outline-4">
<h4 id="org6245974"><span class="section-number-4">4.2.2</span> Set charger configuration</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
A request very similar to getting charger configuration is used to set it. As an example:
</p>

<pre>
$ curl -i -d '{"McH": 240, "LcR": 1000, "LmR": 90, "CcO": 1, "DcO": 1, "LmV": 0.3, "LcV": 3.6, "LmD": 1.1, "ChC": false, "MaV": 4.2, "StV": 3.7, "MiV": 3, "DiR": 1000, "MaT": 40, "DiC": 1, "MsR": 250, "MuL": 0}' -X POST http://10.10.10.30/api/set_config_info
HTTP/1.1 200 OK
Content-Type: text/plane
Content-Length: 8
Connection: close

Received%
</pre>

<p>
When the operation is successful the charger replies with a 'Received' string. When the JSON content is invalid, an error response is sent back:
</p>

<pre>
$ curl -i -d 'fdsgdd' -X POST http://10.10.10.30/api/set_config_info
HTTP/1.1 200 OK
Content-Type: text/plane
Content-Length: 6
Connection: close

failed%
</pre>

<p>
Partial settings updates are possible, for example in order to change the value of a single parameter (for example McH) the following request can be sent:
</p>

<pre>
$ curl -i -d '{"McH": 100}' -X POST http://10.10.10.30/api/set_config_info
HTTP/1.1 200 OK
Content-Type: text/plane
Content-Length: 8
Connection: close

Received%
</pre>

<p>
The value limits that are enforced by the UI can be bypassed by sending configuration parameters directly, for example the maximum allowed value for the LmR parameter (max trickle
charge time) is 180 minutes. Using the following request a higher value can be set, the firmware doesn't enforce the limits from Megacell Monitor UI:
</p>

<pre>
$ curl -i -d '{"LmR": 200}' -X POST http://10.10.10.30/api/set_config_info
HTTP/1.1 200 OK
Content-Type: text/plane
Content-Length: 8
Connection: close

Received%
</pre>

<p>
This results in the LmR parameter successfully set to 200:
</p>

<pre>
$ curl -X POST http://10.10.10.30/api/get_config_info
{
[...]
  "LmR": 200,
[...]
}
</pre>

<p>
The firmware however imposes it's own limits on the parameter values. For example, when a request is sent attempting to change the LmR parameter to 300:
</p>

<pre>
$ curl -i -d '{"LmR": 300}' -X POST http://10.10.10.30/api/set_config_info
HTTP/1.1 200 OK
Content-Type: text/plane
Content-Length: 8
Connection: close

Received%
</pre>

<p>
This results in a success response but the new LmR parameter value received when the configuration is read does not reflect the initially requested value 300, instead the
parameter value seems to be reset to a "firmware-default" which is 90 in this case:
</p>

<pre>
$ curl -X POST http://10.10.10.30/api/get_config_info
{
[...]
  "LmR": 90,
[...]
}
</pre>
</div>
</div>

<div id="outline-container-org4ba84ae" class="outline-4">
<h4 id="org4ba84ae"><span class="section-number-4">4.2.3</span> Charger reset</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
The Megacell Monitor UI contains a button labeled as "Reboot Chargers" which sends the following request:
</p>

<pre>
$ curl -i -d '{ "secret": 20200104}' -X POST http://10.10.10.30/api/reset_charger
HTTP/1.1 200 OK
Content-Type: text/plane
Content-Length: 6
Connection: close

failed
</pre>

<p>
Even though the response indicates a failure the charger does reboot, this can be noticed on the LCD as well as when observing the debug log.
</p>
</div>
</div>

<div id="outline-container-org82daf1e" class="outline-4">
<h4 id="org82daf1e"><span class="section-number-4">4.2.4</span> Get current cell information</h4>
<div class="outline-text-4" id="text-4-2-4">
<p>
An API request used to fetch the current state for each of the 16 charger slots is used to update the charger view in the Megacell Monitor UI. The request is as follows:
</p>

<pre>
$ curl -i -d '{"settings": [{"charger_id": 1}]}' -X POST http://10.10.10.30/api/get_cells_info
HTTP/1.1 200 OK
Content-Type: text/json
Access-Control-Allow-Origin: null
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 1800
Access-Control-Allow-Headers: content-type
Access-Control-Allow-Methods: PUT, POST, GET, DELETE, PATCH, OPTIONS
Content-Length: 5334
Connection: close

{
  "cells": [
    {
      "CiD": 0,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 20,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 1,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 20.32258,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 2,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 20,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 3,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 20.32258,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 4,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 20,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 5,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 21.93548,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 6,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 22.58064,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 7,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 23.87097,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 8,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 23.54839,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 9,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 21.93548,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 10,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 21.29032,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 11,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 19.35484,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 12,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 20.32258,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 13,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 20.64516,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 14,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 20,
      "ChC": false,
      "State": "Low voltage cell"
    },
    {
      "CiD": 15,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 21.29032,
      "ChC": false,
      "State": "Low voltage cell"
    }
  ]
}
</pre>

<p>
The request parameters are always identical and are likely a future extension point where a single API endpoint will be able to handle multiple chargers each having their own slots.
For each slot the following JSON content is returned:
</p>

<pre>
    {
      "CiD": 8,
      "voltage": 0,
      "amps": 0,
      "capacity": 0,
      "chargeCapacity": 0,
      "status": "Not Inserted",
      "esr": 0,
      "action_length": 0,
      "DiC": 1,
      "complete_cycles": 0,
      "temperature": 23.54839,
      "ChC": false,
      "State": "Low voltage cell"
    }
</pre>

<p>
Educated guesses and observation have lead to the following table explaining the meaning of the above fields:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Parameter code</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Unit</th>
<th scope="col" class="org-left">Valid values</th>
<th scope="col" class="org-left">Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">CiD</td>
<td class="org-left">Cell slot identifier</td>
<td class="org-left">N/A</td>
<td class="org-left">slot C1 - 0</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">slot C2 - 1</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#x2026;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">slot C16 - 15</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">voltage</td>
<td class="org-left">Cell voltage</td>
<td class="org-left">V</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">amps</td>
<td class="org-left">Cell current</td>
<td class="org-left">mA</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Positive when charging, negative when discharging</td>
</tr>

<tr>
<td class="org-left">capacity</td>
<td class="org-left">Discharge capacity</td>
<td class="org-left">mAh</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Capacity measured during discharge</td>
</tr>

<tr>
<td class="org-left">chargeCapactity</td>
<td class="org-left">Charge capacity</td>
<td class="org-left">mAh</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">Capacity measured during charge</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">status</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Not Inserted" when no cell in slot</td>
<td class="org-left">This is the string displayed on the LCD</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "New cell inserted" after inserting a cell</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "LVC start charging"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "LVC Charging"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "LVC Charged</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Cell rest 5 Min"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "LVC Completed"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Started Charging"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Stopped Charging"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Hot Charged"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Started Discharging"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Discharged"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Hot Discharged"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Initiating mCap" when capacity test is requested in UI</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "mCap Started Charging"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Wait For ESR Test"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "mCap Started Discharging"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "mCap Store Charging"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Store Charged"</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Bad Cell" - 'State' describes what was the failure</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Overdischarge halt"</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">esr</td>
<td class="org-left">Cell internal resistance</td>
<td class="org-left">Ω</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">action_length</td>
<td class="org-left">Time elapsed since action was started</td>
<td class="org-left">seconds</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">DiC</td>
<td class="org-left">number of disch. cycles</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">complete_cycles</td>
<td class="org-left">number of completed disch. cycles</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">temperature</td>
<td class="org-left">Cell temperature</td>
<td class="org-left">°C</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">ChC</td>
<td class="org-left">Chip controlled charging</td>
<td class="org-left">boolean</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="org-left">State</td>
<td class="org-left">Second component of cell state</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Low voltage cell" when cell voltage is below the minimum for charging</td>
<td class="org-left">Mostly related to failure conditions</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "High ESR Error" when ESR during mCap was higher than maximum</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "HOT charged" and "HOT discharged" when temperature was exceeded during mCap</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Low capacity Error" when capacity during mCap was less than minimum</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "High volt drop Error" when voltage drops more than the maximum during low voltage recovery</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Charge time exceeded" when maximum charging time during mCap is exceeded</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "Healthy" when cell voltage is OK</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "LVC recovery failed" when LVC has failed to recover the cell</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">- "!!!Emergency stop!!!"</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgf533da6" class="outline-4">
<h4 id="orgf533da6"><span class="section-number-4">4.2.5</span> Performing actions by the charger</h4>
<div class="outline-text-4" id="text-4-2-5">
<p>
Performing actions by the charger on particular cells (for example a charge/discharge cycle or LVC) is accomplished by "setting the cell state" using the following request.
In the example below slots 0 and 1 are requested to perform LVC:
</p>

<pre>
$ curl -i -d '{"cells": [{"CiD": 0, "CmD": "alr"},{"CiD": 1, "CmD": "alr"}]}' -X POST http://10.10.10.30/api/set_cell
HTTP/1.1 200 OK
Content-Type: text/plane
Content-Length: 8
Connection: close

Received%
</pre>

<p>
The values of the CmD field correspond to different actions that can be sent to the charger, the following codes have been documented based on what is available in the "New cell
insert actions" in Megacell Monitor UI:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />
</colgroup>

<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Action code</th>
<th scope="col" class="org-left">Action name in Megacell Monitor UI</th>
<th scope="col" class="org-left">Description</th>
<th scope="col" class="org-left">Log message</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">alr</td>
<td class="org-left">Start LVC recovery</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">(Informational) - CellID: 0 - handle_set_cell_state: start lvc recovery</td>
</tr>

<tr>
<td class="org-left">ach</td>
<td class="org-left">Start charging</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">(Notice) - CellID: 0 - handle_set_cell_state: Start Charging</td>
</tr>

<tr>
<td class="org-left">sc</td>
<td class="org-left">Stop charging</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">(Informational) - CellID: 0 - handle_set_cell_state: Stop Charging</td>
</tr>

<tr>
<td class="org-left">adc</td>
<td class="org-left">Start discharging</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">(Informational) - CellID: 0 - handle_set_cell_state: Start Discharging</td>
</tr>

<tr>
<td class="org-left">odc</td>
<td class="org-left">Stop discharging</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">(Informational) - CellID: 0 - handle_set_cell_state: Stop Discharging</td>
</tr>

<tr>
<td class="org-left">act</td>
<td class="org-left">Start capacity test</td>
<td class="org-left">mCap on charger LCD</td>
<td class="org-left">(Informational) - CellID: 0 - handle_set_cell_state: Start cap test</td>
</tr>

<tr>
<td class="org-left">omc</td>
<td class="org-left">Stop capacity test</td>
<td class="org-left">mCap on charger LCD</td>
<td class="org-left">(Informational) - CellID: 0 - handle_set_cell_state: Stop cap test</td>
</tr>

<tr>
<td class="org-left">asc</td>
<td class="org-left">Not available in the Megacell Monitor UI</td>
<td class="org-left">StartStoreCharge</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">osc</td>
<td class="org-left">Not available in the Megacell Monitor UI</td>
<td class="org-left">StopStoreChrage</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dsp</td>
<td class="org-left">Not available in the Megacell Monitor UI</td>
<td class="org-left">DisposeStart</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">dps</td>
<td class="org-left">Not available in the Megacell Monitor UI</td>
<td class="org-left">DisposeStop</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left">"" (empty string)</td>
<td class="org-left">Stop operation</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org55c6c05" class="outline-4">
<h4 id="org55c6c05"><span class="section-number-4">4.2.6</span> Changing the log level</h4>
<div class="outline-text-4" id="text-4-2-6">
<p>
The charger exposes a log on port 8888 (described in detail in the next section). An API request can be used to adjust the log level of messages which are sent to the log.
The request is the following:
</p>

<pre>
$ curl -i -d '{"debug_level": "Debug"}' -X POST http://10.10.10.30/api/set_log_level
HTTP/1.1 200 OK
Content-Type: text/plane
Content-Length: 5
Connection: close

Debug%
</pre>

<p>
The debug levels possible correspond to classical UNIX syslog levels (see the 'man 3 syslog' command):
</p>

<ul class="org-ul">
<li>Emergency</li>
<li>Alert</li>
<li>Critical</li>
<li>Error</li>
<li>Warning</li>
<li>Notice</li>
<li>Informational</li>
<li>Debug</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-orgb4db2f6" class="outline-3">
<h3 id="orgb4db2f6"><span class="section-number-3">4.3</span> The debug log</h3>
<div class="outline-text-3" id="text-4-3">
<p>
The charger firmware provides the possibility to receive a debug log by connecting to the port 8888 of the IP address assigned to the charger. An example dump of messages received
when no cells are inserted:
</p>

<pre>
╰─± nc -v 10.10.10.30 8888
Connection to 10.10.10.30 port 8888 [tcp/ddi-tcp-1] succeeded!
000 00:30:01.682 - (Debug) - No data in log buffer at: 0
000 00:30:01.684 - (Debug) - Adding string to position: 0:No cells
000 00:30:01.686 - (Debug) - Display nRow: 0
000 00:30:01.687 - (Debug) - Display X: 0
000 00:30:01.689 - (Debug) - Display Y: 0
000 00:30:01.789 - (Debug) - Display output string: No cells
000 00:30:01.803 - (Debug) - Log buffer has data at: 0
000 00:30:01.805 - (Debug) - No data in log buffer at: 1
000 00:30:01.806 - (Debug) - Adding string to position: 1:inserted
000 00:30:01.808 - (Debug) - Display nRow: 0
000 00:30:01.809 - (Debug) - Display X: 0
000 00:30:01.814 - (Debug) - Display Y: 0
000 00:30:01.816 - (Debug) - Display output string: No cells
000 00:30:01.821 - (Debug) - Display nRow: 1
000 00:30:01.824 - (Debug) - Display X: 0
000 00:30:01.827 - (Debug) - Display Y: 17
000 00:30:01.830 - (Debug) - Display output string: inserted
000 00:30:01.836 - (Debug) - Log buffer has data at: 0
000 00:30:01.838 - (Debug) - Log buffer has data at: 1
000 00:30:01.839 - (Debug) - No data in log buffer at: 2
000 00:30:01.841 - (Debug) - Adding string to position: 2:000 00:30:01.836
000 00:30:01.845 - (Debug) - Display nRow: 0
000 00:30:01.852 - (Debug) - Display X: 0
000 00:30:01.853 - (Debug) - Display Y: 0
000 00:30:01.856 - (Debug) - Display output string: No cells
000 00:30:01.869 - (Debug) - Display nRow: 1
000 00:30:01.871 - (Debug) - Display X: 0
000 00:30:01.872 - (Debug) - Display Y: 17
000 00:30:01.875 - (Debug) - Display output string: inserted
000 00:30:01.882 - (Debug) - Display nRow: 2
000 00:30:01.886 - (Debug) - Display X: 0
000 00:30:01.891 - (Debug) - Display Y: 34
000 00:30:01.893 - (Debug) - Display output string: 000 00:30:01.836
</pre>

<p>
As the debug log contains a lot of repeating messages from the LCD display routines it's useful to filter those out:
</p>

<pre>
nc -v 10.10.10.30 8888 | grep -v -F -e '(Debug) - Display' -e '(Debug) - Adding string to position' -e '(Debug) - Log buffer has data' -e '(Debug) - No data in log buffer'
Connection to 10.10.10.30 port 8888 [tcp/ddi-tcp-1] succeeded!
000 00:02:23.383 - (Debug) - Received request to send cell details.
000 00:02:23.559 - (Notice) - Loop delay: 166.00 ms (Uptime: 000 00:02:23.560 )
000 00:02:23.562 - (Notice) - FREEHeap: 16648 DIFF: -3240 Fragmentation: 2
</pre>

<p>
The log messages received when a new cell is inserted:
</p>

<pre>
000 00:03:59.963 - (Notice) - CiD: 0 - Cell voltage: 1.26 - cell_amps: 0.00 - full_charge_threshold:  - Cell status: Not Inserted - cell_watchdog: New cell inserted Detected..
000 00:03:59.964 - (Warning) - ClearCellData: 0
000 00:03:59.966 - (Warning) - ClearCellData: 0
000 00:04:00.829 - (Debug) - Update display for cell: 1
</pre>

<p>
The log messages received when LVC is requested for an inserted cell:
</p>

<pre>
000 00:12:30.474 - (Notice) - Received request to change cell state.
000 00:12:30.476 - (Informational) - Deserialization succeeded
000 00:12:30.487 - (Informational) - CellID: 0 - handle_set_cell_state: start lvc recovery
000 00:12:30.489 - (Warning) - ClearCellData: 0
000 00:12:30.998 - (Informational) - LVC: eWorkflow: LVC_Check_cell_voltage
000 00:12:31.000 - (Informational) - LmV: Check details for cell: 0
000 00:12:31.001 - (Informational) - LmV: 0.30
000 00:12:31.002 - (Informational) - Cell voltage: 1.25
000 00:12:31.004 - (Informational) - LVC: Started charging: 0
000 00:12:34.930 - (Notice) - Setting fan speed to: 10%
000 00:12:34.943 - (Notice) - CiD: 1 - Cell voltage: 4.24 - cell_amps: 0.00 - full_charge_threshold:  - Cell status: Not Inserted - cell_watchdog: New cell inserted Detected..
000 00:12:34.945 - (Warning) - ClearCellData: 1
000 00:12:34.946 - (Warning) - ClearCellData: 1
000 00:12:34.947 - (Notice) - Setting fan speed to: 10%
000 00:12:35.094 - (Informational) - LVC: eWorkflow: LVC_Wait_for_readiness
000 00:12:35.114 - (Notice) - CiD: 1 - Cell voltage: 0.00 - cell_amps: 0.00 - full_charge_threshold:  - Cell status: New cell inserted - cell_watchdog: Cell removed from charger...
000 00:12:35.116 - (Warning) - ClearCellData: 1
000 00:12:35.117 - (Warning) - ClearCellData: 1
000 00:12:35.118 - (Notice) - Setting fan speed to: 10%
000 00:12:35.230 - (Debug) - Received request to send cell details.
000 00:12:35.592 - (Informational) - LVC: eWorkflow: LVC_Wait_for_readiness
000 00:12:36.091 - (Informational) - LVC: eWorkflow: LVC_Wait_for_readiness
</pre>

<p>
Log entries received when a capacity test is requested:
</p>

<pre>
000 00:47:24.709 - (Notice) - Received request to change cell state.
000 00:47:24.712 - (Informational) - Deserialization succeeded
000 00:47:24.724 - (Informational) - CellID: 0 - handle_set_cell_state: Start cap test
000 00:47:24.727 - (Warning) - startCapTestMacro - reseting dischargeCapacity
000 00:47:24.729 - (Warning) - startCapTestMacro: clearing chargeCapacity: 0
000 00:47:25.239 - (Notice) - CiD: 0 - ProcessWorkflow: eWorkflow::initiate_mCap
000 00:47:25.242 - (Notice) - ProcessWorkflow: eWorkflow::initiate_mCap -> Started charging
000 00:47:25.244 - (Debug) - CiD: 0 - Voltage read: 3.96 - Max volt: 4.20
000 00:47:25.244 - (Debug) - ProcessWorkflow: eWorkflow::initiate_mCap -> Next step -> eWorkflow::WaitForChargeReadiness_mcap
000 00:47:25.245 - (Warning) - initiate_mCap: clearing chargeCapacity: 0
000 00:47:25.245 - (Warning) - initiate_mCap - reseting dischargeCapacity
000 00:47:25.249 - (Notice) - Setting fan speed to: 10%
000 00:47:29.860 - (Debug) - Update display for cell: 1
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Maciej Grela</p>
<p class="date">Created: 2022-01-13 21:43</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
